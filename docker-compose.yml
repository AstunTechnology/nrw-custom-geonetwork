version: '3'

volumes:
  gndata:
  esdata:

services:
  geonetwork:
    image: public.ecr.aws/i7c2f1z3/scotgov-custom-geonetwork:latest
    # build:
    #   context: .
    #   dockerfile: Dockerfile.local
    container_name: geonetwork
    ports:
      - 8080:8080
    security_opt:
      - no-new-privileges=true
    restart: unless-stopped
    environment:
      DATA_DIR: /catalogue-data
      KB_URL: http://kibana:5601
      GEONETWORK_DB_TYPE: postgres
      GEONETWORK_DB_HOST: ${POSTGRES_DB_HOST}
      GEONETWORK_DB_PORT: 5432
      GEONETWORK_DB_NAME: ${POSTGRES_DB_NAME}
      GEONETWORK_DB_USERNAME: ${POSTGRES_DB_USERNAME}
      GEONETWORK_DB_PASSWORD: ${POSTGRES_DB_PASSWORD}
      JAVA_OPTS: 
        -Dorg.eclipse.jetty.annotations.AnnotationParser.LEVEL=OFF
        -Djava.security.egd=file:/dev/./urandom -Djava.awt.headless=true
        -Xms512M -Xss512M -Xmx2G -XX:+UseConcMarkSweepGC
        -Dgeonetwork.resources.dir=/catalogue-data/resources
        -Dgeonetwork.data.dir=/catalogue-data
        -Dgeonetwork.codeList.dir=/catalogue-data/thesauri
        -Dgeonetwork.schema.dir=/usr/local/tomcat/webapps/geonetwork/WEB-INF/data/config/schema_plugins
        -Dkb.url=http://kibana:5601
        -Djava.security.properties=/usr/local/openjdk-8/jre/lib/security/java.security.overrides
      logger.level: WARN
    logging:
      driver: "json-file"
    healthcheck:
      test: ["CMD-SHELL", "curl -i -H \"Accept: application/json\" -f http://localhost:8080/geonetwork/srv/api/0.1/site || exit 1"]
      interval: 1m
      timeout: 10s
      retries: 5
    networks:
      - esnet
    volumes:
      # general overrides
      - gndata:/catalogue-data
      - ./thesauri:/catalogue-data/thesauri
      # schema overrides
      # dcat is built in because it's a pita to deploy this way at the moment
      # gemini 2.3
      - ../iso19139.gemini23/src/main/plugin/iso19139.gemini23:/usr/local/tomcat/webapps/geonetwork/WEB-INF/data/config/schema_plugins/iso19139.gemini23
      - ../iso19139.gemini23/src/main/config/translations/en-schema-iso19139.gemini23.json:/usr/local/tomcat/webapps/geonetwork/catalog/locales/en-schema-iso19139.gemini23.json
      - ../iso19139.gemini23/target/schema-iso19139.gemini23-3.12-SNAPSHOT.jar:/usr/local/tomcat/webapps/geonetwork/WEB-INF/lib/schema-iso19139.gemini23-3.12-SNAPSHOT.jar
      - ./geonetwork/WEB-INF/data/config/schema_plugins/iso19139.gemini23/index-fields/index-subtemplate.xsl:/usr/local/tomcat/webapps/geonetwork/WEB-INF/data/config/schema_plugins/iso19139.gemini23/index-fields/index-subtemplate.xsl
      - ./geonetwork/WEB-INF/data/config/schema_plugins/iso19139.gemini23/layout/config-editor.xml:/usr/local/tomcat/webapps/geonetwork/WEB-INF/data/config/schema_plugins/iso19139.gemini23/layout/config-editor.xml
      # gemini 2.2
      - ../iso19139.gemini22_GN3/src/main/plugin/iso19139.gemini22:/usr/local/tomcat/webapps/geonetwork/WEB-INF/data/config/schema_plugins/iso19139.gemini22
      - ../iso19139.gemini22_GN3/src/main/config/translations/en-schema-iso19139.gemini22.json:/usr/local/tomcat/webapps/geonetwork/catalog/locales/en-schema-iso19139.gemini22.json
      - ../iso19139.gemini22_GN3/target/schema-iso19139.gemini22-3.7.jar:/usr/local/tomcat/webapps/geonetwork/WEB-INF/lib/schema-iso19139.gemini22-3.7.jar
      - ../iso19139.gemini22_GN3/src/main/plugin/iso19139.gemini22/process/xml_gemini22gemini23-schemaupgrade.xsl:/usr/local/tomcat/webapps/geonetwork/WEB-INF/data/config/schema_plugins/iso19139/process/xml_gemini22gemini23-schemaupgrade.xsl
      - ./geonetwork/xsl/conversion/import/xml_gemini22gemini23.xsl:/usr/local/tomcat/webapps/geonetwork/xsl/conversion/import/xml_gemini22gemini23.xsl
      # iso19139
      - ./geonetwork/WEB-INF/data/config/schema_plugins/iso19139/index-fields/index-subtemplate.xsl:/usr/local/tomcat/webapps/geonetwork/WEB-INF/data/config/schema_plugins/iso19139/index-fields/index-subtemplate.xsl
      # security overrides
      - ./geonetwork/WEB-INF/web.xml:/usr/local/tomcat/webapps/geonetwork/WEB-INF/web.xml
      - ./geonetwork/WEB-INF/config.properties.local:/usr/local/tomcat/webapps/geonetwork/WEB-INF/config.properties
      - ./geonetwork/META-INF/context.xml:/usr/local/tomcat/webapps/geonetwork/META-INF/context.xml
      - ./tomcat/server.xml:/usr/local/tomcat/conf/server.xml
      - ./tomcat/web.xml:/usr/local/tomcat/conf/web.xml
      - ./jdk/jre/lib/security/java.security.overrides:/usr/local/openjdk-8/jre/lib/security/java.security.overrides

  nginx:
    image: nginxinc/nginx-unprivileged
    container_name: nginx
    restart: unless-stopped
    volumes:
          - ./nginx/default.local:/etc/nginx/conf.d/default.conf
          - ./nginx/root/robots.txt:/var/www/html/robots.txt
    ports:
      - "80:80"
      - "82:82"
    security_opt:
      - no-new-privileges=true
    logging:
          driver: "json-file"
    networks:
      - esnet
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:80/robots.txt || exit 1"]
      interval: 1m
      timeout: 10s
      retries: 5




networks:
  esnet:
    driver: bridge