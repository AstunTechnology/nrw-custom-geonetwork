version: '3'

volumes:
  esdata:
  gndata:

services:
  geonetwork:
    image: geonetwork:latest
    # build:
    #   context: ./certs
    #   dockerfile: dockerfile.geonetwork
    container_name: geonetwork
    ports:
      - 8080:8080
    environment:
      DATA_DIR: /catalogue-data
      KB_URL: http://kibana:5601
      GEONETWORK_DB_TYPE: postgres
      GEONETWORK_DB_HOST: ${POSTGRES_DB_HOST}
      GEONETWORK_DB_PORT: 5432
      GEONETWORK_DB_NAME: ${POSTGRES_DB_NAME}
      GEONETWORK_DB_USERNAME: ${POSTGRES_DB_USERNAME}
      GEONETWORK_DB_PASSWORD: ${POSTGRES_DB_PASSWORD}
      ES_URL: ${ES_URL}
      ES_HOST: ${ES_HOST}
      ES_USERNAME: ${ES_USERNAME}
      ES_PASSWORD: ${ES_PASSWORD}
      JAVA_OPTS: 
        -Dorg.eclipse.jetty.annotations.AnnotationParser.LEVEL=OFF
        -Djava.security.egd=file:/dev/./urandom -Djava.awt.headless=true
        -Xms512M -Xss512M -Xmx2G -XX:+UseConcMarkSweepGC
        -Dgeonetwork.resources.dir=/usr/local/tomcat/webapps/geonetwork/WEB-INF/data/resources
        -Dgeonetwork.data.dir=/catalogue-data
        -Dgeonetwork.codeList.dir=/catalogue-data/thesauri
        -Dgeonetwork.schema.dir=/usr/local/tomcat/webapps/geonetwork/WEB-INF/data/config/schema_plugins
        -Dkb.url=http://kibana:5601
        -Djava.security.properties=/usr/local/openjdk-8/jre/lib/security/java.security.overrides
        -Dlog_dir=/usr/local/tomcat/webapps/geonetwork/WEB-INF/data/
      logger.level: WARN
    logging:
      driver: "json-file"
    security_opt:
      - no-new-privileges=true
    healthcheck:
      test: ["CMD-SHELL", "curl -i -H \"Accept: application/json\" -f http://localhost:8080/geonetwork/srv/api/0.1/site || exit 1"]
      interval: 1m
      timeout: 10s
      retries: 5
    restart: unless-stopped
    networks:
      - esnet
    volumes:
      # general overrides
      - gndata:/usr/local/tomcat/webapps/geonetwork/WEB-INF/data
      - ./thesauri:/catalogue-data/thesauri
      # skins
      # - ../geonetwork-ea-skin/views/default/templates/footer.html:/usr/local/tomcat/webapps/geonetwork/catalog/views/default/templates/footer.html
      # - ../geonetwork-ea-skin/views/default/templates/searchForm.html:/usr/local/tomcat/webapps/geonetwork/catalog/views/default/templates/searchForm.html
      # - ../geonetwork-ea-skin/views/default/templates/home.html:/usr/local/tomcat/webapps/geonetwork/catalog/views/default/templates/home.html
      # - ../geonetwork-ea-skin/components/search/resultsview/partials/viewtemplates/editor.html:/usr/local/tomcat/webapps/geonetwork/catalog/components/search/resultsview/partials/viewtemplates/editor.html
      # - ../geonetwork-ea-skin/components/search/searchmanager/partials/searchresults.html:/usr/local/tomcat/webapps/geonetwork/catalog/components/search/searchmanager/partials/searchresults.html
      # - ../geonetwork-ea-skin/components/history/GnHistoryService.js:/usr/local/tomcat/webapps/geonetwork/catalog/components/history/GnHistoryService.js
      # - ../geonetwork-ea-skin/templates/admin/harvest/type/webdav.html:/usr/local/tomcat/webapps/geonetwork/catalog/templates/admin/harvest/type/webdav.html
      # - ../geonetwork-ea-skin/locales/en-custom.json:/usr/local/tomcat/webapps/geonetwork/catalog/locales/en-custom.json
      # - ../geonetwork-ea-skin/style/srv_custom_style.less:/usr/local/tomcat/webapps/geonetwork/catalog/style/srv_custom_style.less
      # schema overrides
      # dcat and non-spatial
      - ../iso19139.nonspatial/src/main/plugin/iso19139.nonspatial:/usr/local/tomcat/webapps/geonetwork/WEB-INF/data/config/schema_plugins/iso19139.nonspatial
      - ../iso19139.nonspatial/target/schema-iso19139.nonspatial-3.12-SNAPSHOT.jar:/usr/local/tomcat/webapps/geonetwork/WEB-INF/lib/schema-iso19139.nonspatial-3.12-SNAPSHOT.jar
      - ../iso19139.nonspatial/src/main/plugin/iso19139.nonspatial/layout/tpl-rdf-iso19139.xsl:/usr/local/tomcat/webapps/geonetwork/WEB-INF/data/config/schema_plugins/iso19139/layout/tpl-rdf.xsl
      - ../iso19139.nonspatial/web/src/main/webapp/xslt/services/dcat/rdf.xsl:/usr/local/tomcat/webapps/geonetwork/xslt/services/dcat/rdf.xsl
      - ../iso19139.nonspatial/src/main/plugin/iso19139.nonspatial/process/iso19139nonspatial-schemaupgrade.xsl:/usr/local/tomcat/webapps/geonetwork/xsl/conversion/import/iso19139nonspatial-schemaupgrade.xsl

      #- ../nonspatialmetadata/schemas/iso19139/src/main/plugin/iso19139/present/csw/dcat-brief.xsl:/usr/local/tomcat/webapps/geonetwork/WEB-INF/config/data/config/schema_plugins/iso19139/present/csw/dcat-brief.xsl
      # #GDPR
      # - ../iso19139.gdpr/src/main/plugin/iso19139.gdpr:/usr/local/tomcat/webapps/geonetwork/WEB-INF/data/config/schema_plugins/iso19139.gdpr
      # - ../iso19139.gdpr/target/schema-iso19139.gdpr-3.12-SNAPSHOT.jar:/usr/local/tomcat/webapps/geonetwork/WEB-INF/lib/schema-iso19139.gdpr-3.12-SNAPSHOT.jar
      #EAMP
      - ../iso19139.eamp/src/main/plugin/iso19139.eamp:/usr/local/tomcat/webapps/geonetwork/WEB-INF/data/config/schema_plugins/iso19139.eamp
      - ../iso19139.eamp/src/main/translations/en-schema-iso19139.eamp.json:/usr/local/tomcat/webapps/geonetwork/catalog/locales/en-schema-iso19139.eamp.json
      - ../iso19139.eamp/target/schema-iso19139.eamp-3.12-SNAPSHOT.jar:/usr/local/tomcat/webapps/geonetwork/WEB-INF/lib/schema-iso19139.eamp-3.12-SNAPSHOT.jar
      # gemini 2.3
      - ../iso19139.gemini23/src/main/plugin/iso19139.gemini23:/usr/local/tomcat/webapps/geonetwork/WEB-INF/data/config/schema_plugins/iso19139.gemini23
      - ../iso19139.gemini23/src/main/config/translations/en-schema-iso19139.gemini23.json:/usr/local/tomcat/webapps/geonetwork/catalog/locales/en-schema-iso19139.gemini23.json
      - ../iso19139.gemini23/target/schema-iso19139.gemini23-3.12-SNAPSHOT.jar:/usr/local/tomcat/webapps/geonetwork/WEB-INF/lib/schema-iso19139.gemini23-3.12-SNAPSHOT.jar
      - ./geonetwork/WEB-INF/data/config/schema_plugins/iso19139.gemini23/index-fields/index-subtemplate.xsl:/usr/local/tomcat/webapps/geonetwork/WEB-INF/data/config/schema_plugins/iso19139.gemini23/index-fields/index-subtemplate.xsl
      - ./geonetwork/WEB-INF/data/config/schema_plugins/iso19139.gemini23/layout/config-editor.xml:/usr/local/tomcat/webapps/geonetwork/WEB-INF/data/config/schema_plugins/iso19139.gemini23/layout/config-editor.xml
      # gemini 2.2
      - ../iso19139.gemini22/src/main/plugin/iso19139.gemini22:/usr/local/tomcat/webapps/geonetwork/WEB-INF/data/config/schema_plugins/iso19139.gemini22
      #- ../iso19139.gemini22/src/main/plugin/iso19139.gemini22/process/xml_gemini22gemini23-schemaupgrade.xsl:/usr/local/tomcat/webapps/geonetwork/WEB-INF/data/config/schema_plugins/iso19139/process/xml_gemini22gemini23-schemaupgrade.xsl
      - ../iso19139.gemini22/src/main/config/translations/en-schema-iso19139.gemini22.json:/usr/local/tomcat/webapps/geonetwork/catalog/locales/en-schema-iso19139.gemini22.json
      - ../iso19139.gemini22/target/schema-iso19139.gemini22-3.7.jar:/usr/local/tomcat/webapps/geonetwork/WEB-INF/lib/schema-iso19139.gemini22-3.7.jar
      - ./geonetwork/xsl/conversion/import/xml_gemini22gemini23.xsl:/usr/local/tomcat/webapps/geonetwork/xsl/conversion/import/xml_gemini22gemini23.xsl
      # iso19139
      - ./geonetwork/WEB-INF/data/config/schema_plugins/iso19139/index-fields/index-subtemplate.xsl:/usr/local/tomcat/webapps/geonetwork/WEB-INF/data/config/schema_plugins/iso19139/index-fields/index-subtemplate.xsl
      # security overrides
      # - ./geonetwork/WEB-INF/web.xml:/usr/local/tomcat/webapps/geonetwork/WEB-INF/web.xml
      # - ./geonetwork/WEB-INF/config.properties:/usr/local/tomcat/webapps/geonetwork/WEB-INF/config.properties
      # - ./geonetwork/WEB-INF/config/config-service-xml-api.xml:/usr/local/tomcat/webapps/geonetwork/WEB-INF/config/config-service-xml-api.xml
      # - ./geonetwork/WEB-INF/config/config-service-search.xml:/usr/local/tomcat/webapps/geonetwork/WEB-INF/config/config-service-search.xml
      # - ./geonetwork/WEB-INF/config-summary.xml:/usr/local/tomcat/webapps/geonetwork/WEB-INF/config-summary.xml
      # - ./geonetwork/META-INF/context.xml:/usr/local/tomcat/webapps/geonetwork/META-INF/context.xml
      # - ./tomcat/server.xml:/usr/local/tomcat/conf/server.xml
      # - ./tomcat/web.xml:/usr/local/tomcat/conf/web.xml
      # - ./jdk/jre/lib/security/java.security.overrides:/usr/local/openjdk-8/jre/lib/security/java.security.overrides
      # - ./geonetwork/catalog/js/admin/DashboardController.js:/usr/local/tomcat/webapps/geonetwork/catalog/js/admin/DashboardController.js

  

  # nginx:
  #   image: nginx
  #   container_name: nginx
  #   volumes:
  #         - ./nginx/default.local:/etc/nginx/conf.d/default.conf
  #         - ./nginx/servers:/etc/nginx/servers
  #         - ./nginx/locations:/etc/nginx/locations
  #         - ./nginx/root/robots.txt:/var/www/html/robots.txt
  #         # - ./certs/letsencrypt/live:/etc/nginx/certs
  #         # - ./certs/dhparam.pem:/etc/nginx/ssl/dhparam.pem
  #   ports:
  #     - "80:80"
  #     # - "82:82"
  #     # - "8443:8443"
  #   security_opt:
  #     - no-new-privileges=true
  #   logging:
  #         driver: "json-file"
  #   networks:
  #     - esnet
  #   healthcheck:
  #     test: ["CMD-SHELL", "curl -f http://localhost:80/robots.txt || exit 1"]
  #     interval: 1m
  #     timeout: 10s
  #     retries: 5
  #   restart: unless-stopped

networks:
  esnet:
    driver: bridge